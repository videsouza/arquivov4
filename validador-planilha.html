<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Validador de Planilhas | Gestão Documental</title>

  <!-- Fonte institucional GOV.BR -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Rawline:wght@300;400;600;700&display=swap">

  <!-- Ícones (opcional, será removido em v1.1 se desejar) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- CSS institucional -->
  <link rel="stylesheet" href="govbr.css">
</head>

<body>

  <!-- Acessibilidade -->
  <a href="#conteudo" class="skip-link">
    Pular para o conteúdo principal
  </a>

  <!-- Barra GOV.BR -->
  <div class="barra-institucional">
    Sistema Interno – Gestão Documental
  </div>

  <!-- Conteúdo principal -->
  <main id="conteudo">
    <div class="container">

      <h1>Validador de Planilhas Arquivísticas</h1>

      <!-- ================= PASSO 1 ================= -->
      <section>
        <h2>1. Seleção da planilha</h2>

        <label for="arquivo">
          Arquivo (CSV, XLS ou XLSX)
        </label>
        <input
          type="file"
          id="arquivo"
          accept=".csv,.xls,.xlsx"
        >

        <div id="abas-container" hidden>
          <label for="aba">Selecionar aba</label>
          <select id="aba"></select>
        </div>
      </section>

      <!-- ================= PASSO 2 ================= -->
      <section>
        <h2>2. Pré-visualização (5 primeiras linhas)</h2>

        <div id="preview" tabindex="0" aria-live="polite">
          <p>Nenhuma planilha carregada.</p>
        </div>
      </section>

      <!-- Rodapé -->
      <footer>
        <p>
          © 2025 <strong>Sistema de Apoio à Gestão Documental</strong>
        </p>
        <p>
          Desenvolvido por Vinicius A. de Souza
        </p>
      </footer>

    </div>
  </main>

  <!-- ================= BIBLIOTECAS ================= -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- ================= SCRIPT PRINCIPAL ================= -->
  <script>
    const inputArquivo = document.getElementById('arquivo');
    const preview = document.getElementById('preview');
    const abasContainer = document.getElementById('abas-container');
    const selectAba = document.getElementById('aba');

    let workbookGlobal = null;

    inputArquivo.addEventListener('change', handleUpload);

    function handleUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      preview.innerHTML = '<p>Processando arquivo...</p>';

      const reader = new FileReader();

      if (file.name.toLowerCase().endsWith('.csv')) {
        reader.onload = e => {
          const resultado = Papa.parse(e.target.result, {
            skipEmptyLines: true
          });
          abasContainer.hidden = true;
          renderPreview(resultado.data);
        };
        reader.readAsText(file);
      } else {
        reader.onload = e => {
          const data = new Uint8Array(e.target.result);
          workbookGlobal = XLSX.read(data, { type: 'array' });

          const abas = workbookGlobal.SheetNames;
          popularAbas(abas);
          carregarAba(abas[0]);
        };
        reader.readAsArrayBuffer(file);
      }
    }

    function popularAbas(abas) {
      selectAba.innerHTML = '';

      abas.forEach(nome => {
        const option = document.createElement('option');
        option.value = nome;
        option.textContent = nome;
        selectAba.appendChild(option);
      });

      abasContainer.hidden = abas.length <= 1;

      selectAba.onchange = () => carregarAba(selectAba.value);
    }

    function carregarAba(nome) {
      const sheet = workbookGlobal.Sheets[nome];
      const dados = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      renderPreview(dados);
    }

    function renderPreview(dados) {
      preview.innerHTML = '';

      if (!dados || dados.length === 0) {
        preview.innerHTML = '<p>Planilha vazia.</p>';
        return;
      }

      const tabela = document.createElement('table');
      tabela.className = 'preview-table';

      dados.slice(0, 5).forEach((linha, index) => {
        const tr = document.createElement('tr');

        linha.forEach(celula => {
          const cel = document.createElement(index === 0 ? 'th' : 'td');
          cel.textContent = celula ?? '';
          tr.appendChild(cel);
        });

        tabela.appendChild(tr);
      });

      preview.appendChild(tabela);
    }
  </script>

</body>
</html>
