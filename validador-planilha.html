<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Validador de Planilhas | Gestão Documental</title>

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Rawline:wght@300;400;600;700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <link rel="stylesheet" href="govbr.css">
</head>

<body>

<a href="#conteudo" class="skip-link">Pular para o conteúdo principal</a>

<div class="barra-institucional">
  Sistema Interno – Gestão Documental
</div>

<main id="conteudo">
  <div class="container">

    <h1>Validador de Planilhas Arquivísticas</h1>

    <!-- PASSO 1 -->
    <section>
      <h2>1. Seleção da planilha</h2>

      <label for="arquivo">Arquivo (CSV, XLS ou XLSX)</label>
      <input type="file" id="arquivo" accept=".csv,.xls,.xlsx"
             aria-describedby="arquivo-ajuda">
      <p id="arquivo-ajuda" class="hint">
        Formatos aceitos: CSV, XLS e XLSX.
      </p>

      <div id="abas-container" hidden>
        <label for="aba">Selecionar aba</label>
        <select id="aba"></select>
      </div>
    </section>

    <!-- PASSO 2 -->
    <section>
      <h2>2. Pré-visualização</h2>
      <div id="preview" tabindex="0" aria-live="polite">
        <p>Nenhuma planilha carregada.</p>
      </div>
    </section>

    <!-- PASSO 2.5 -->
    <section id="estrutura-section" hidden>
      <h2>Estrutura da planilha</h2>

      <fieldset>
        <legend>A planilha possui cabeçalho?</legend>

        <label>
          <input type="radio" name="temCabecalho" value="sim" checked>
          Sim, a primeira linha contém os nomes das colunas
        </label>

        <label>
          <input type="radio" name="temCabecalho" value="nao">
          Não, a planilha começa diretamente com os dados
        </label>
      </fieldset>

      <label for="linha-inicial">
        Linha onde começam os dados
      </label>
      <input type="number" id="linha-inicial" value="2" min="1">

      <button id="btn-definir-estrutura">
        Confirmar estrutura
      </button>
    </section>

    <!-- PASSO 3 -->
    <section id="colunas-section" hidden>
      <h2>3. Gerenciamento de colunas</h2>
      <p>
        Marque as colunas que deseja remover e ajuste os nomes dos
        cabeçalhos conforme o padrão institucional.
      </p>
      <div id="colunas-container"></div>
    </section>

    <!-- PASSO 4 -->
    <section id="acoes-section" hidden>
      <h2>4. Aplicação e validação</h2>
      <button id="btn-aplicar">
        Aplicar colunas e validar dados
      </button>
    </section>

    <!-- RELATÓRIO -->
    <section id="relatorio-section" hidden aria-live="polite">
      <h2>Relatório de validação</h2>
      <div id="relatorio"></div>
    </section>

    <!-- ================= EXPORTAÇÃO ================= -->
<section id="exportacao-section" hidden>
  <h2>Exportação</h2>

  <button id="btn-exportar-csv">
    Baixar CSV tratado
  </button>

  <button id="btn-exportar-xlsx">
    Baixar XLSX tratado
  </button>
</section>


    <footer>
      <p>© 2025 <strong>Sistema de Apoio à Gestão Documental</strong></p>
      <p>Desenvolvido por Vinicius A. de Souza</p>
    </footer>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const inputArquivo = document.getElementById('arquivo');
  const preview = document.getElementById('preview');
  const abasContainer = document.getElementById('abas-container');
  const selectAba = document.getElementById('aba');

  const estruturaSection = document.getElementById('estrutura-section');
  const colunasSection = document.getElementById('colunas-section');
  const colunasContainer = document.getElementById('colunas-container');
  const acoesSection = document.getElementById('acoes-section');
  const relatorioSection = document.getElementById('relatorio-section');

  let workbookGlobal = null;
  let dadosAtuais = [];
  let columnConfig = [];
  let dadosProcessados = [];


  inputArquivo.addEventListener('change', handleUpload);

  function handleUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    resetarInterface();

    const reader = new FileReader();

    if (file.name.toLowerCase().endsWith('.csv')) {
      reader.onload = ev => {
        const res = Papa.parse(ev.target.result, { skipEmptyLines: false });
        abasContainer.hidden = true;
        prepararDados(res.data);
      };
      reader.readAsText(file);
    } else {
      reader.onload = ev => {
        const data = new Uint8Array(ev.target.result);
        workbookGlobal = XLSX.read(data, { type: 'array' });
        popularAbas(workbookGlobal.SheetNames);
        carregarAba(workbookGlobal.SheetNames[0]);
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function popularAbas(abas) {
    selectAba.innerHTML = '';
    abas.forEach(n => {
      const o = document.createElement('option');
      o.value = n;
      o.textContent = n;
      selectAba.appendChild(o);
    });
    abasContainer.hidden = abas.length <= 1;
    selectAba.onchange = () => carregarAba(selectAba.value);
  }

  function carregarAba(nome) {
    const sheet = workbookGlobal.Sheets[nome];
    prepararDados(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
  }

  function prepararDados(dados) {
    dadosAtuais = dados;
    renderPreview(dados);
    estruturaSection.hidden = false;
  }

  document.getElementById('btn-definir-estrutura')
    .addEventListener('click', definirEstrutura);

  function definirEstrutura() {
    const possuiCabecalho =
      document.querySelector('input[name="temCabecalho"]:checked').value === 'sim';

    const linhaInicial =
      parseInt(document.getElementById('linha-inicial').value, 10) - 1;

    let cabecalhos;
    let dadosLimpos;

    if (possuiCabecalho) {
      cabecalhos = dadosAtuais[linhaInicial];
      dadosLimpos = dadosAtuais.slice(linhaInicial + 1);
    } else {
      cabecalhos = dadosAtuais[linhaInicial].map((_, i) => `Coluna ${i + 1}`);
      dadosLimpos = dadosAtuais.slice(linhaInicial);
    }

    dadosAtuais = [cabecalhos, ...dadosLimpos];
    montarGerenciamentoColunas(cabecalhos);

    estruturaSection.hidden = true;
  }

  function renderPreview(dados) {
    preview.innerHTML = '';
    const table = document.createElement('table');
    dados.slice(0, 5).forEach((linha, i) => {
      const tr = document.createElement('tr');
      linha.forEach(c => {
        const el = document.createElement(i === 0 ? 'th' : 'td');
        el.textContent = c ?? '';
        tr.appendChild(el);
      });
      table.appendChild(tr);
    });
    preview.appendChild(table);
  }

function montarGerenciamentoColunas(cabecalhos) {
  colunasContainer.innerHTML = '';
  columnConfig = [];

  cabecalhos.forEach((nome, i) => {
    columnConfig.push({
      index: i,
      original: nome,
      novoNome: nome,
      excluir: false
    });

    const item = document.createElement('div');
    item.className = 'coluna-item';

    item.innerHTML = `
      <div class="coluna-header">
        <span class="coluna-num">#${i + 1}</span>
        <span class="coluna-original">${nome}</span>
      </div>

      <div class="coluna-actions">
        <label>
          <input type="checkbox" data-i="${i}">
          Excluir
        </label>

        <label>
          Novo nome
          <input type="text" value="${nome}" data-r="${i}">
        </label>
      </div>
    `;

    colunasContainer.appendChild(item);
  });

  colunasSection.hidden = false;
  acoesSection.hidden = false;

  document.querySelectorAll('[data-i]').forEach(cb => {
    cb.onchange = e =>
      columnConfig[e.target.dataset.i].excluir = e.target.checked;
  });

  document.querySelectorAll('[data-r]').forEach(inp => {
    inp.oninput = e =>
      columnConfig[e.target.dataset.r].novoNome = e.target.value;
  });
}


  document.getElementById('btn-aplicar').onclick = aplicarColunas;

function aplicarColunas() {
  const linhas = dadosAtuais.slice(1);
  const colAtivas = columnConfig.filter(c => !c.excluir);

  const cabecalho = colAtivas.map(c => c.novoNome || c.original);

  let removidas = 0;
  let vazios = 0;
  let validas = [];

  linhas.forEach(l => {
    const nova = colAtivas.map(c => l[c.index]);

    if (linhaLixo(nova)) {
      removidas++;
      return;
    }

    nova.forEach(v => {
      if (valorVazio(v)) vazios++;
    });

    validas.push(nova);
  });

  dadosProcessados = [cabecalho, ...validas];

  exibirRelatorio(linhas.length, validas.length, removidas, vazios);

  document.getElementById('exportacao-section').hidden = false;
}

  /* ===== EXPORTAÇÃO CSV ===== */

  document
    .getElementById('btn-exportar-csv')
    .addEventListener('click', exportarCSV);

  function exportarCSV() {
    if (!dadosProcessados.length) return;

    const csv = Papa.unparse(dadosProcessados);

    const blob = new Blob([csv], {
      type: 'text/csv;charset=utf-8;'
    });

    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'planilha_tratada.csv';
    a.click();

    URL.revokeObjectURL(url);
  }


  /* ===== EXPORTAÇÃO XLSX ===== */

  document
    .getElementById('btn-exportar-xlsx')
    .addEventListener('click', exportarXLSX);

  function exportarXLSX() {
    if (!dadosProcessados.length) return;

    const ws = XLSX.utils.aoa_to_sheet(dadosProcessados);
    const wb = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(wb, ws, 'Dados Tratados');

    XLSX.writeFile(wb, 'planilha_tratada.xlsx');
  }


  function valorVazio(v) {
    return v == null || (typeof v === 'string' && v.trim() === '');
  }

  function linhaLixo(l) {
    return l.every(v => valorVazio(v) || /^[\-\*]+$/.test(String(v)));
  }

  function exibirRelatorio(t, v, r, z) {
    document.getElementById('relatorio').innerHTML = `
      <ul>
        <li>Linhas analisadas: ${t}</li>
        <li>Linhas válidas: ${v}</li>
        <li>Linhas removidas: ${r}</li>
        <li>Campos vazios: ${z}</li>
      </ul>`;
    relatorioSection.hidden = false;
  }

  function resetarInterface() {
    estruturaSection.hidden = true;
    colunasSection.hidden = true;
    acoesSection.hidden = true;
    relatorioSection.hidden = true;
  }
</script>

</body>
</html>
