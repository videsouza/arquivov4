<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Validador de Planilhas | Gestão Documental</title>

  <!-- Fonte institucional GOV.BR -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Rawline:wght@300;400;600;700&display=swap">

  <!-- Ícones (opcional, será removido em v1.1 se desejar) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- CSS institucional -->
  <link rel="stylesheet" href="govbr.css">
</head>

<body>

  <!-- Acessibilidade -->
  <a href="#conteudo" class="skip-link">
    Pular para o conteúdo principal
  </a>

  <!-- Barra GOV.BR -->
  <div class="barra-institucional">
    Sistema Interno – Gestão Documental
  </div>

  <!-- Conteúdo principal -->
  <main id="conteudo">
    <div class="container">

      <h1>Validador de Planilhas Arquivísticas</h1>

      <!-- ================= PASSO 1 ================= -->
      <section>
        <h2>1. Seleção da planilha</h2>

        <label for="arquivo">
          Arquivo (CSV, XLS ou XLSX)
        </label>
        <input
          type="file"
          id="arquivo"
          accept=".csv,.xls,.xlsx"
        >

        <div id="abas-container" hidden>
          <label for="aba">Selecionar aba</label>
          <select id="aba"></select>
        </div>
      </section>

      <!-- ================= PASSO 2 ================= -->
      <section>
        <h2>2. Pré-visualização (5 primeiras linhas)</h2>

        <div id="preview" tabindex="0" aria-live="polite">
          <p>Nenhuma planilha carregada.</p>
        </div>
      </section>

      <!-- ================= PASSO 3 ================= -->
    <section id="colunas-section" hidden>
      <h2>3. Gerenciamento de colunas</h2>

      <p>
        Selecione as colunas que deseja remover e ajuste os nomes dos
        cabeçalhos conforme o padrão institucional.
      </p>

        <div id="colunas-container"></div>
      </section>


      <!-- ================= PASSO 4 ================= -->
<section id="acoes-section" hidden>
  <h2>4. Aplicação e validação</h2>

  <button id="btn-aplicar">
    Aplicar colunas e validar dados
  </button>
</section>

<!-- ================= RELATÓRIO ================= -->
<section id="relatorio-section" hidden aria-live="polite">
  <h2>Relatório de validação</h2>
  <div id="relatorio"></div>
</section>
      
      <!-- Rodapé -->
      <footer>
        <p>
          © 2025 <strong>Sistema de Apoio à Gestão Documental</strong>
        </p>
        <p>
          Desenvolvido por Vinicius A. de Souza
        </p>
      </footer>

    </div>
  </main>

  <!-- ================= BIBLIOTECAS ================= -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- ================= SCRIPT PRINCIPAL ================= -->
  <script>
   
  const inputArquivo = document.getElementById('arquivo');
  const preview = document.getElementById('preview');
  const abasContainer = document.getElementById('abas-container');
  const selectAba = document.getElementById('aba');

  const colunasSection = document.getElementById('colunas-section');
  const colunasContainer = document.getElementById('colunas-container');

  let workbookGlobal = null;
  let dadosAtuais = [];
  let columnConfig = [];

  inputArquivo.addEventListener('change', handleUpload);

  function handleUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    preview.innerHTML = '<p>Processando arquivo...</p>';
    colunasSection.hidden = true;

    const reader = new FileReader();

    if (file.name.toLowerCase().endsWith('.csv')) {
      reader.onload = e => {
        const resultado = Papa.parse(e.target.result, {
          skipEmptyLines: true
        });
        abasContainer.hidden = true;
        processarDados(resultado.data);
      };
      reader.readAsText(file);
    } else {
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        workbookGlobal = XLSX.read(data, { type: 'array' });

        const abas = workbookGlobal.SheetNames;
        popularAbas(abas);
        carregarAba(abas[0]);
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function popularAbas(abas) {
    selectAba.innerHTML = '';
    abas.forEach(nome => {
      const option = document.createElement('option');
      option.value = nome;
      option.textContent = nome;
      selectAba.appendChild(option);
    });

    abasContainer.hidden = abas.length <= 1;
    selectAba.onchange = () => carregarAba(selectAba.value);
  }

  function carregarAba(nome) {
    const sheet = workbookGlobal.Sheets[nome];
    const dados = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    processarDados(dados);
  }

  function processarDados(dados) {
    dadosAtuais = dados;
    renderPreview(dados);
    montarGerenciamentoColunas(dados[0]);
  }

  function renderPreview(dados) {
    preview.innerHTML = '';

    if (!dados || dados.length === 0) {
      preview.innerHTML = '<p>Planilha vazia.</p>';
      return;
    }

    const tabela = document.createElement('table');
    tabela.className = 'preview-table';

    dados.slice(0, 5).forEach((linha, index) => {
      const tr = document.createElement('tr');

      linha.forEach(celula => {
        const cel = document.createElement(index === 0 ? 'th' : 'td');
        cel.textContent = celula ?? '';
        tr.appendChild(cel);
      });

      tabela.appendChild(tr);
    });

    preview.appendChild(tabela);
  }

  /* ================= GERENCIAMENTO DE COLUNAS ================= */

  function montarGerenciamentoColunas(cabecalhos) {
    colunasContainer.innerHTML = '';
    columnConfig = [];

    cabecalhos.forEach((nome, index) => {
      const config = {
        index,
        original: nome || `Coluna ${index + 1}`,
        novoNome: nome || `Coluna ${index + 1}`,
        excluir: false
      };

      columnConfig.push(config);

      const wrapper = document.createElement('div');
      wrapper.className = 'coluna-item';

      wrapper.innerHTML = `
        <label>
          <input type="checkbox" data-index="${index}">
          Excluir
        </label>

        <span class="coluna-original">
          ${config.original}
        </span>

        <input
          type="text"
          value="${config.novoNome}"
          data-rename="${index}"
          aria-label="Renomear coluna ${config.original}"
        >
      `;

      colunasContainer.appendChild(wrapper);
    });

    colunasSection.hidden = false;

    bindEventosColunas();
  }

  function bindEventosColunas() {
    document.querySelectorAll('[data-index]').forEach(cb => {
      cb.addEventListener('change', e => {
        const i = e.target.dataset.index;
        columnConfig[i].excluir = e.target.checked;
      });
    });

    document.querySelectorAll('[data-rename]').forEach(input => {
      input.addEventListener('input', e => {
        const i = e.target.dataset.rename;
        columnConfig[i].novoNome = e.target.value.trim();
      });
    });
  }

    <script>
  const btnAplicar = document.getElementById('btn-aplicar');
  const acoesSection = document.getElementById('acoes-section');
  const relatorioSection = document.getElementById('relatorio-section');
  const relatorioDiv = document.getElementById('relatorio');

  let dadosProcessados = [];

  btnAplicar.addEventListener('click', aplicarColunasEValidar);

  function aplicarColunasEValidar() {
    if (!dadosAtuais.length) return;

    const cabecalhoOriginal = dadosAtuais[0];
    const linhas = dadosAtuais.slice(1);

    const colunasAtivas = columnConfig.filter(c => !c.excluir);

    const novoCabecalho = colunasAtivas.map(c => c.novoNome || c.original);

    let linhasValidas = [];
    let linhasRemovidas = 0;
    let camposVazios = 0;

    linhas.forEach(linha => {
      // Remove colunas excluídas
      const novaLinha = colunasAtivas.map(c => linha[c.index]);

      // Verifica linha lixo
      if (linhaLixo(novaLinha)) {
        linhasRemovidas++;
        return;
      }

      // Validação de campos vazios
      novaLinha.forEach(valor => {
        if (valorVazio(valor)) {
          camposVazios++;
        }
      });

      linhasValidas.push(novaLinha);
    });

    dadosProcessados = [novoCabecalho, ...linhasValidas];

    exibirRelatorio({
      totalLinhas: linhas.length,
      linhasValidas: linhasValidas.length,
      linhasRemovidas,
      camposVazios
    });
  }

  /* ================= VALIDAÇÕES ================= */

  function valorVazio(valor) {
    return (
      valor === null ||
      valor === undefined ||
      (typeof valor === 'string' && valor.trim() === '')
    );
  }

  function linhaLixo(linha) {
    return linha.every(celula =>
      valorVazio(celula) ||
      /^[\-\*\_]+$/.test(String(celula).trim())
    );
  }

  /* ================= RELATÓRIO ================= */

  function exibirRelatorio(resumo) {
    relatorioDiv.innerHTML = `
      <ul>
        <li><strong>Total de linhas analisadas:</strong> ${resumo.totalLinhas}</li>
        <li><strong>Linhas válidas:</strong> ${resumo.linhasValidas}</li>
        <li><strong>Linhas removidas (lixo):</strong> ${resumo.linhasRemovidas}</li>
        <li><strong>Campos vazios encontrados:</strong> ${resumo.camposVazios}</li>
      </ul>
    `;

    relatorioSection.hidden = false;
  }

  /* Exibir botão quando colunas estiverem prontas */
  const observer = new MutationObserver(() => {
    if (columnConfig.length) {
      acoesSection.hidden = false;
    }
  });

  observer.observe(document.getElementById('colunas-container'), {
    childList: true
  });
</script>


</body>
</html>
